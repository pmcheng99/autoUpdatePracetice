<html><head><meta charset="UTF-8"><style type="text/css">@font-face {
  font-family: 'rbicon';
  src: url(chrome-extension://dipiagiiohfljcicegpgffpbnjmgjcnf/fonts/rbicon.woff2) format("woff2");
  font-weight: normal;
  font-style: normal; }
</style></head>
<body cz-shortcut-listen="true"><h2><span id="actionText"></span></h2><img src="waiting.gif">
<form name="DemoForm" action="sign" method="POST">
<input type="hidden" name="tbsPackage">
</form>
<script type="text/javascript">
//Step 6 receive msg func = MakeSignature
function receiveMessage(event){
	var matchstr="(.+)($|:\\d+$)";
	if (event.origin.match(matchstr)==null)
	{
		var ret={};
		ret["func"]="sign";
		ret["ret_code"]=0x7600000F;
		ret["message"]="禁止存取的網域";
		window.opener.postMessage(JSON.stringify(ret),"*");
		window.close();
		return;
	}
	var ret = JSON.parse(event.data);
	var actionText=document.getElementById("actionText");
	
	if(ret.func){
		var action=null;
		var actionFun=null;
		//Step 7 MakeSignature
		if(ret.func=="MakeSignature"){
			action="sign";
			actionFun="sign";
			actionText.innerHTML="簽章中";
		}else if(ret.func=="umakeSig"){
			action="umakeSig";
			actionFun="umakeSig";
			actionText.innerHTML="簽章中";
		}else if(ret.func=="GetUserCert"){
			action="pkcs11info?withcert=true";
			actionFun="pkcs11info";
			actionText.innerHTML="憑證讀取中";
		}else if(ret.func=="DecryptData"){
			action="decrypt";
			actionFun="decrypt";
			actionText.innerHTML="解密中";
		}else if(ret.func=="writecert"){
			action="writecert";
			actionFun="writecert";
			actionText.innerHTML="寫憑證中";
		} else if(ret.func=="CheckEnvir"){
			action="pkcs11info";
			actionFun="pkcs11info";
			actionText.innerHTML="資料讀取中";
		} else if(ret.func=="changeUserPINCode"){
			action="CardManagement/sendCardCommand";
			actionFun="changeUserPINCode";
			actionText.innerHTML="密碼變更中";
		}else if(ret.func=="makeCsr"){
			action="makeCsr";
			actionFun="makeCsr";
			actionText.innerHTML="製作憑證請求檔中";
		}else if(ret.func=="signDetached"){
			action="signDetached";
			actionFun="signDetached";
			actionText.innerHTML="簽章中";
		}
		//Step 8 action = sign
		if(action!=null){
			var xhttp = new XMLHttpRequest();
			// xhttp listener
			xhttp.onreadystatechange = function() {
				if (xhttp.readyState == 4) 
				{
					if(xhttp.status == 200)
					{	
						// Step 10 res func = sign				
						window.opener.postMessage(xhttp.responseText,"*");
						window.close();
					}else{
						window.opener.postMessage('{"func":"'+actionFun+'","ret_code":'+xhttp.status+'}',"*");
						window.close();
					}
				}
			};
			// step 9 send sign request
			xhttp.open("POST", action, true);
			// request json 
			xhttp.send("tbsPackage="+event.data);
		}else{
			window.opener.postMessage('{"func":"'+actionFun+'","ret_code":'+0x7600000E+'}',"*");
			window.close();
		}
	}
}
window.addEventListener("message", receiveMessage, false);
var tbsData = {};
tbsData["func"]="getTbs";
var msg=JSON.stringify(tbsData);
var postTarget=window.opener;
// Step 3 send {"func":"getTbs"}
postTarget.postMessage(msg,"*");
</script>
<br>

<div id="rememberry__extension__root" style="all: unset;"></div></body></html>